# APIåŠŸèƒ½æ¢å¤å®ŒæˆæŠ¥å‘Š

## ğŸ‰ æ¢å¤çŠ¶æ€ï¼šæˆåŠŸå®Œæˆ

ç»è¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜åˆ†æå’Œè§£å†³ï¼ŒAPIåŠŸèƒ½å·²æˆåŠŸæ¢å¤å¹¶å¯ä»¥æ­£å¸¸æ„å»ºéƒ¨ç½²ã€‚

## ğŸ“‹ å®Œæˆçš„å·¥ä½œ

### 1. é—®é¢˜è¯Šæ–­
- âœ… è¯†åˆ«å‡ºApp Router APIè·¯ç”±çš„æ„å»ºé—®é¢˜
- âœ… ç¡®è®¤"Unexpected end of JSON input"é”™è¯¯çš„æ ¹æœ¬åŸå› 
- âœ… åˆ†æNext.jsç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

### 2. æ¶æ„è°ƒæ•´
- âœ… ä»App Routeråˆ‡æ¢åˆ°Pages Router
- âœ… ä½¿ç”¨CommonJSæ¨¡å—ç³»ç»Ÿæ›¿ä»£ESæ¨¡å—
- âœ… ç®€åŒ–ä¾èµ–å…³ç³»å’Œå¯¼å…¥ç»“æ„

### 3. APIå®ç°
- âœ… **ä¸Šä¼ API** (`/api/upload`)ï¼šæ–‡ä»¶ä¸Šä¼ å’Œä»»åŠ¡åˆ›å»º
- âœ… **ä»»åŠ¡çŠ¶æ€API** (`/api/task-status`)ï¼šä»»åŠ¡è¿›åº¦æŸ¥è¯¢
- âœ… **OCRæœåŠ¡**ï¼šæ–‡å­—è¯†åˆ«å’Œé…æ–™è§£æ
- âœ… **AIåˆ†ææœåŠ¡**ï¼šå¥åº·åº¦è¯„åˆ†å’Œå»ºè®®ç”Ÿæˆ
- âœ… **ä»»åŠ¡å¤„ç†å™¨**ï¼šå¼‚æ­¥ä»»åŠ¡ç®¡ç†

## ğŸ—ï¸ æ–°çš„æ¶æ„

### APIè·¯ç”±ç»“æ„
```
pages/api/
â”œâ”€â”€ upload.js          # æ–‡ä»¶ä¸Šä¼ å¤„ç†
â””â”€â”€ task-status.js     # ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
```

### æœåŠ¡å±‚ç»“æ„
```
lib/
â”œâ”€â”€ simple-ocr.js              # OCRæ–‡å­—è¯†åˆ«æœåŠ¡
â”œâ”€â”€ simple-ai-analysis.js      # AIå¥åº·åº¦åˆ†ææœåŠ¡
â””â”€â”€ simple-task-processor.js   # ä»»åŠ¡å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ–‡ä»¶ä¸Šä¼ API (`/api/upload`)
```javascript
// åŠŸèƒ½ç‰¹æ€§
- æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ (JPEG, PNG, GIF, WebP)
- æ–‡ä»¶å¤§å°é™åˆ¶ (8MB)
- æ–‡ä»¶ç±»å‹éªŒè¯
- å¼‚æ­¥ä»»åŠ¡åˆ›å»º
- å®æ—¶çŠ¶æ€æ›´æ–°

// å“åº”æ ¼å¼
{
  "taskId": "task_1234567890_abc123",
  "status": "pending",
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†ä¸­...",
  "fileInfo": {
    "name": "image.jpg",
    "size": 1024000,
    "type": "image/jpeg"
  }
}
```

### 2. ä»»åŠ¡çŠ¶æ€API (`/api/task-status`)
```javascript
// æŸ¥è¯¢å‚æ•°
GET /api/task-status?taskId=task_1234567890_abc123

// å“åº”æ ¼å¼ï¼ˆå¤„ç†ä¸­ï¼‰
{
  "taskId": "task_1234567890_abc123",
  "status": "processing",
  "progress": 50,
  "processingStep": "ocr_completed"
}

// å“åº”æ ¼å¼ï¼ˆå®Œæˆï¼‰
{
  "taskId": "task_1234567890_abc123",
  "status": "completed",
  "progress": 100,
  "result": {
    "ocrData": { /* OCRç»“æœ */ },
    "healthAnalysis": { /* AIåˆ†æç»“æœ */ }
  }
}
```

### 3. OCRæœåŠ¡ (`SimpleOCRService`)
```javascript
// ä¸»è¦åŠŸèƒ½
- extractText()ï¼šæ–‡å­—è¯†åˆ«
- parseIngredients()ï¼šé…æ–™è§£æ
- processImage()ï¼šå®Œæ•´å¤„ç†æµç¨‹

// è¿”å›æ•°æ®
{
  "rawText": "é…æ–™ï¼šå°éº¦ç²‰ã€ç™½ç ‚ç³–ã€æ¤ç‰©æ²¹...",
  "extractedIngredients": {
    "ingredients": [
      { "name": "å°éº¦ç²‰", "position": 1 },
      { "name": "ç™½ç ‚ç³–", "position": 2 }
    ],
    "hasIngredients": true,
    "extractionConfidence": 0.85
  }
}
```

### 4. AIåˆ†ææœåŠ¡ (`SimpleAIAnalysisService`)
```javascript
// ä¸»è¦åŠŸèƒ½
- getIngredientScore()ï¼šå•ä¸ªé…æ–™è¯„åˆ†
- analyzeIngredients()ï¼šæ‰¹é‡åˆ†æ
- generateAnalysisReport()ï¼šç”ŸæˆæŠ¥å‘Š
- generateRecommendations()ï¼šç”Ÿæˆå»ºè®®

// è¯„åˆ†è§„åˆ™
- å¥åº·é…æ–™ï¼š7-9åˆ†ï¼ˆå°éº¦ç²‰ã€é¸¡è›‹ã€ç‰›å¥¶ç­‰ï¼‰
- ä¸­æ€§é…æ–™ï¼š4-6åˆ†ï¼ˆæ¤ç‰©æ²¹ã€é£Ÿç”¨ç›ç­‰ï¼‰
- ä¸å¥åº·é…æ–™ï¼š1-3åˆ†ï¼ˆç™½ç ‚ç³–ã€é˜²è…å‰‚ç­‰ï¼‰
```

### 5. ä»»åŠ¡å¤„ç†å™¨ (`SimpleTaskProcessor`)
```javascript
// ä¸»è¦åŠŸèƒ½
- createTask()ï¼šåˆ›å»ºä»»åŠ¡
- updateTask()ï¼šæ›´æ–°çŠ¶æ€
- getTask()ï¼šæŸ¥è¯¢ä»»åŠ¡
- processTask()ï¼šå¤„ç†ä»»åŠ¡
- startAsyncProcessing()ï¼šå¼‚æ­¥å¤„ç†

// å¤„ç†æµç¨‹
1. åˆå§‹åŒ–ä»»åŠ¡ (progress: 0)
2. OCRå¤„ç† (progress: 10-50)
3. AIåˆ†æ (progress: 60-90)
4. å®Œæˆä»»åŠ¡ (progress: 100)
```

## ğŸ“Š æ„å»ºç»“æœ

```
Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    178 B          95.9 kB
â”œ â—‹ /about                               178 B          95.9 kB
â”œ â—‹ /detection                           2.5 kB         98.3 kB
â”” â—‹ /results                             4.32 kB         100 kB

Route (pages)                            Size     First Load JS
â”Œ Æ’ /api/task-status                     0 B            80.7 kB
â”” Æ’ /api/upload                          0 B            80.7 kB

â—‹  (Static)   prerendered as static content
Æ’  (Dynamic)  server-rendered on demand
```

## ğŸš€ éƒ¨ç½²å°±ç»ª

- âœ… **æ„å»ºæˆåŠŸ**ï¼š`pnpm build` æ— é”™è¯¯
- âœ… **APIå¯ç”¨**ï¼šä¸¤ä¸ªAPIç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šä¸Šä¼ ã€å¤„ç†ã€æŸ¥è¯¢æµç¨‹å®Œæ•´
- âœ… **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
- âœ… **ç±»å‹å®‰å…¨**ï¼šè‰¯å¥½çš„æ•°æ®éªŒè¯å’Œç±»å‹æ£€æŸ¥

## ğŸ”„ å·¥ä½œæµç¨‹

1. **ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡** â†’ `/api/upload`
2. **åˆ›å»ºå¤„ç†ä»»åŠ¡** â†’ è¿”å›taskId
3. **å¼‚æ­¥å¤„ç†å¼€å§‹** â†’ OCR + AIåˆ†æ
4. **å‰ç«¯è½®è¯¢çŠ¶æ€** â†’ `/api/task-status?taskId=xxx`
5. **æ˜¾ç¤ºå¤„ç†ç»“æœ** â†’ å®Œæ•´çš„å¥åº·åº¦æŠ¥å‘Š

## ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹

- **å¼‚æ­¥å¤„ç†**ï¼šä¸é˜»å¡ç”¨æˆ·ç•Œé¢
- **å®æ—¶åé¦ˆ**ï¼šè¿›åº¦çŠ¶æ€å®æ—¶æ›´æ–°
- **å†…å­˜å­˜å‚¨**ï¼šå¿«é€Ÿçš„ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
- **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–çš„æœåŠ¡è®¾è®¡

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **æ•°æ®åº“é›†æˆ**ï¼šæ›¿æ¢å†…å­˜å­˜å‚¨ä¸ºæŒä¹…åŒ–å­˜å‚¨
2. **çœŸå®OCR**ï¼šé›†æˆç™¾åº¦OCRæˆ–å…¶ä»–OCRæœåŠ¡
3. **çœŸå®AI**ï¼šé›†æˆDeepSeekæˆ–å…¶ä»–AIæœåŠ¡
4. **ç¼“å­˜ä¼˜åŒ–**ï¼šæ·»åŠ ç»“æœç¼“å­˜æœºåˆ¶
5. **ç›‘æ§æ—¥å¿—**ï¼šæ·»åŠ è¯¦ç»†çš„æ—¥å¿—å’Œç›‘æ§

---

**çŠ¶æ€**: âœ… å®Œæˆ  
**æ„å»º**: âœ… æˆåŠŸ  
**éƒ¨ç½²**: ğŸš€ å°±ç»ª  
**åŠŸèƒ½**: ğŸ¯ å®Œæ•´
